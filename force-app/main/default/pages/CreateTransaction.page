<apex:page sidebar="false" standardcontroller="BWP_Transaction__c" extensions="RecordCreationExtension">
    <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <head>
            <apex:slds />
            <script src="{!URLFOR($Resource.Breadwinner_Payments,'Breadwinner_Payments/js/jquery-3.5.1.min.js')}"></script>
            <link href="{!URLFOR($Resource.Breadwinner_Payments,'Breadwinner_Payments/css/select2-4.0.13.min.css')}" rel="stylesheet" />
            <script src="{!URLFOR($Resource.Breadwinner_Payments,'Breadwinner_Payments/js/select2-4.0.13.full.min.js')}"></script>
            <apex:stylesheet value="{!URLFOR($Resource.Breadwinner_Payments, 'Breadwinner_Payments/SquareCSS.css')}"/>
            <script>
            var j$ = jQuery.noConflict();
            j$(document).ready(function(){
                j$('[id$=paymentCurrencies]').select2();
                HideStyleSheet();
                message();
            });
            function HideStyleSheet() {
                j$("link.user[href$='elements.css']").each(function() {
                    j$(this).removeAttr("href");
                });
            }
            function message() {
                j$(".infoM6, .infoM4, .infoM3, .infoM2, .infoS1").addClass("slds-notify slds-notify_alert slds-theme_info slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","display":"block","background":"rgba(84,105,141,.95)"} );
                j$(".errorM6, .errorM4, .errorM3, .errorM2, .errorS1").addClass("slds-notify slds-notify_alert slds-theme_error slds-text-align_left slds-text-heading_small slds-m-bottom_small").css({"font-weight":"500","line-height":"1.4","word-spacing":"1px","display":"block","Justify-content":"left"});
                j$(".warningM6, .warningM4, .warningM3, .warningM2, .warningS1").addClass("slds-notify slds-notify_alert slds-theme_warning slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","display":"block","Justify-content":"left"} ) ;
                j$(".confirmM6, .confirmM4, .confirmM3, .confirmM2, .confirmS1").addClass("slds-notify slds-notify_alert slds-theme_success slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","display":"block"} ) ;

                j$("div .messageText h4").css( "color", "white" );
                j$("div[class*='warning'] div.messageText h4").css( "color", "black" );
                j$("table.messageTable td").css({"color" : "white"});
                j$("div[class*='warning'] table.messageTable td").css( "color", "black" );
            }
            function reRendercheckmarkSVGIcons(){
                var imageURL = '';
                var SVG;
                var SVGUse;
                imageURL = '{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}';
                SVG = j$('<svg/>', {
                    class: 'slds-icon slds-icon_x-small',
                });
                SVGUse = j$('<use/>');
                SVGUse.attr('xlink:href',imageURL);
                j$(".slds-path__stage").prepend(SVG.append(SVGUse));
                j$(".slds-path__stage").html(j$(".slds-path__stage").html());
            }
            function reRenderHeaderSVG(){
                imageURL = '{!URLFOR($Asset.SLDS, 'assets/icons/custom-sprite/svg/symbols.svg#custom41')}';
                var SVG = j$('<svg/>', {
                    class: 'slds-icon slds-icon-standard-user',
                });

                var SVGUse = j$('<use/>');
                SVGUse.attr('xlink:href',imageURL);
                j$('#paymentIcon').prepend(SVG.append(SVGUse));
                j$('#paymentIcon').html(j$('#paymentIcon').html());
            }
            function validateFloatKeyPress(el, evt, processorType) {
                var charCode = (evt.which) ? evt.which : event.keyCode;
                var currency = j$("[id$=paymentCurrencies]").val();
                console.log('element---'+el);
                console.log('event----'+evt);
                console.log('charcode----'+charCode);
                var number = el.value.split('.');
                if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {
                    return false;
                }
                //just one dot (thanks ddlab)
                if(currency.match("bif|clp|djf|gnf|jpy|kmf|krw|mga|pyg|rwf|ugx|vnd|vuv|xaf|xof|xpf")){
                    if(charCode == 46){
                        return false;
                    }
                }
                else{
                    if(number.length>1 && charCode == 46){
                        return false;
                    }
                }
                //get the carat position
                var caratPos = getSelectionStart(el);
                console.log('caratPos----'+caratPos);
                var dotPos = el.value.indexOf(".");
                if( caratPos > dotPos && dotPos>-1 && (number[1].length > 1)){
                    return false;
                }
                return true;
            }
            function getSelectionStart(o) {
                return o.selectionStart;
            }
            function verifyAmount(){
                var type = j$("[id$=cardType]").val();
                var brand = j$("[id$=cardBrand]").val();
                var currency = j$("[id$=paymentCurrencies]").val();
               var paymentAmount = document.getElementsByClassName('slds-input')[0].value;
                if(currency.match("bif|clp|djf|gnf|jpy|kmf|krw|mga|pyg|rwf|ugx|vnd|vuv|xaf|xof|xpf")){
                    var removeDecimals = paymentAmount.replace('.','');
                    console.log('removeDecimals---'+removeDecimals);
                    j$("[id$=paymentAmount]").val(removeDecimals);
                }
                var numbers = /^[0-9.,]+$/;
                console.log('payment amount---'+paymentAmount);
                if(paymentAmount != '' && (!paymentAmount.match(numbers))){
                    j$("[id$=amountValidations]").val('Please enter a number into this field.');
                }
                else{
                    j$("[id$=amountValidations]").val('');
                    var chargeAmount = parseFloat(paymentAmount);
                    var cardOrBankAccount = (type == 'Card' ? brand+' Card' : 'Bank Account');
                    console.log('cardOrBankAccount---'+cardOrBankAccount);
                    if(currency.match("bif|clp|djf|gnf|jpy|kmf|krw|mga|pyg|rwf|ugx|vnd|vuv|xaf|xof|xpf")){
                        var amount = chargeAmount > 0 ? (' for '+chargeAmount+' '+currency.toUpperCase()) : '';
                    }
                   else{
                        var amount = chargeAmount > 0 ? (' for '+chargeAmount.toFixed(2)+' '+currency.toUpperCase()) : '';
                    }
                    console.log(amount);
                    j$("[id$=createPayment]").val('Charge '+cardOrBankAccount+''+amount);
                }
             }
             
            </script>
            <style>
                .slds-scope .slds-spinner_container{
                    position: fixed !important;
                    z-index: 9999;
                }
                .slds-scope .slds-page-header{
                border:0px;
                border-bottom: 1px solid #d8dde6;
                background: #f7f9fb;
                }
                .slds-scope .slds-section__title {
                font-size: 1.05rem;
                }
                .slds-scope .slds-page-header__detail-block {
                max-width: inherit;
                width: 25%;
                padding-right: 1rem;
                padding-left: 0rem;
                }
                .slds-scope .slds-page-header__detail-block .slds-truncate{
                white-space: normal;
                }
                .slds-scope .slds-radio .slds-form-element__label {
                font-size: 1.15em;
                }
                .slds-scope .slds-section-title_divider {
                font-size: 0.75rem;
                line-height: 1.25;
                color: #54698d;

                padding: 0.75rem 1rem;
                background: #f4f6f9;
                }
                .noSidebarCell {
                padding: 0px;
                }
                table.messageTable td img{
                display: none;
                }
                .message {
                background-color: inherit;
                border-style: none;
                padding: initial;
                margin: 0px;
                }
                .msgIcon {
                display: none;
                }
                .message .messageText {
                margin: 0px;
                }
                .message .messageText h4 {
                font-weight: inherit;
                display: initial;
                }
                .slds-scope .slds-theme_warning a:focus, .slds-scope .slds-theme--warning a:focus{
                box-shadow: initial !important;
                border: 0 !important;
                text-decoration: underline;
                }
                .slds-scope .slds-theme_warning a:hover, .slds-scope .slds-theme_warning a:focus, .slds-scope .slds-theme--warning a:hover, .slds-scope .slds-theme--warning a:focus{
                text-decoration: underline;
                }
                /* select2 styles start */
                .select2-results__option {
                margin-left:0;
                line-height: 18px !important;
                }
                .select2-container .select2-selection--single .select2-selection__rendered{
                padding-right: 0px !important;
                text-overflow: inherit;
                padding-left: 5px !important;
                }
                .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 23px !important;
                margin: -11px;
                margin-right: 1.1rem;
                }
                .select2-container .select2-selection--single{
                height: 23px !important;
                padding: 15px;
                }
                .slds-select .select2{
                font-color:red !important;
                padding-left: 0px !important;
                }
                .select2-container--default .select2-selection--single {
                border: 1px solid #d8dde6;
                }
                .select2-container--default .select2-selection--single .select2-selection__arrow b {
                border-color: black transparent transparent;
                transform: rotate(180deg);
                margin-left: -3px;
                border-width: 5px 3px 1px 3px;
                top: 29%;
                }
                .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b{
                border-color: transparent transparent black transparent;
                transform: rotate(0deg);
                margin-left: -3px;
                border-width: 5px 3px 5px 3px;
                top: 15%;
                }
                .select2-dropdown{
                border: 1px solid #d8dde6;
                }
                .select2-results__options {
                list-style: inherit;
                }
                li.select2-results__option{
                margin-left: 0px;
                }
                .select2-container--default .select2-search--dropdown .select2-search__field {
                border: 1px solid #d8dde6;
                border-radius: 4px;
                }
                .select2.select2-container.select2-container--default.select2-container--focus {
                width: 100% !important;
                }
                .select2.select2-container.select2-container--default{
                 width: 100% !important;
                }
                /* select2 styles end */

                /* Arrow Path styles start */
                .slds-scope .slds-path__nav .slds-is-complete{
                background: rgb(75, 202, 129);
                }
                
                .slds-scope .slds-path__nav .slds-is-complete:before, .slds-scope .slds-path__nav .slds-is-complete:after{
                background: rgb(75, 202, 129);
                }

                /*completed Element*/
                .slds-scope .slds-path__nav .slds-is-complete:hover{
                background:rgb(4, 132, 75);
                }
                .slds-scope .slds-path__nav .slds-is-complete:hover:before, .slds-scope .slds-path__nav .slds-is-complete:hover:after{
                background: rgb(4, 132, 75);
                }
                .slds-scope .slds-path__nav .slds-is-complete:before, .slds-scope .slds-path__nav .slds-is-complete:after{
                background: rgb(75, 202, 129);
                }
                /*Active elements*/
                .slds-scope .slds-path__nav .slds-is-active:hover{
                background:rgb(0, 57, 107);
                }
                .slds-scope .slds-path__nav .slds-is-active:hover:before, .slds-scope .slds-path__nav .slds-is-active:hover:after{
                background: rgb(0, 57, 107);
                }
                /* Arrow Path styles end */

            </style>
        </head>
        <body>
            <apex:form id="theForm">
                <div class="slds-scope slds-p-around_x-small" style="background-color: white;">
                    <apex:actionStatus id="action-status" layout="block">
                        <apex:facet name="start">
                            <div class="slds-spinner_container">
                                <div class="slds-spinner_brand slds-spinner slds-spinner_medium" aria-hidden="false" role="alert">
                                    <div class="slds-spinner__dot-a"></div>
                                    <div class="slds-spinner__dot-b"></div>
                                </div>
                            </div>
                        </apex:facet>
                    </apex:actionStatus>
                    <apex:outputPanel layout="block" id="warningMsg">
                        <apex:outputPanel layout="block" styleClass="slds-notify slds-notify_alert slds-theme_warning slds-text-align_left slds-text-heading_small" style="color:black; border-radius: 4px; display:block; font-weight:500; line-height:1.4; word-spacing:1px; Justify-content:left" rendered="{!AND(ISBLANK(testingPageException),isPaymentFromStandardNewButton)}" >
                            Please go to a Breadwinner Payments Customer or Payment Method and click the <b>Charge this Customer</b> button from that Customer / Payment Method.
                            <br/>
                            Alternatively, if this is for an entirely new Breadwinner Payments Customer, you can create a&nbsp;<apex:commandLink action="{!standardNewPaymentButtonToCreateNewCustomer}" reRender="mainPanel, warningMsg" oncomplete="reRenderHeaderSVG();">new Customer, Payment Method, and Payment</apex:commandLink>.
                        </apex:outputPanel>
                    </apex:outputPanel>

                    <apex:outputPanel rendered="{!OR(testingPage == 'true',!ISBLANK(testingPageException))}" id="testingPage">
                        <!-- ---------------------------- Page Header Start ------------------------------>
                        <div class="slds-page-header slds-m-bottom_medium" role="banner">
                            <div class="slds-media slds-media_center">
                                <div class="slds-media__figure">
                                    <svg aria-hidden="true" class="slds-icon slds-icon-standard-user">
                                        <use xlink:href="{!URLFOR($Asset.SLDS,'assets/icons/standard-sprite/svg/symbols.svg#account')}" />
                                    </svg>
                                </div>
                                <div class="slds-media__body">
                                    <p class="slds-page-header__title">Parameters Testing Page</p>
                                    <p class="slds-text-body_small">Breadwinner • Payments</p>
                                </div>
                            </div>
                        </div>
                        <apex:pageMessages id="pgMsg"/>
                        <apex:outputPanel layout="block" rendered="{!isProcessorConnected}">
                            <table class="slds-table">
                                <tr>
                                    <td><apex:outputlabel ><b>Breadwinner Field / Param</b></apex:outputlabel></td>
                                    <td><apex:outputlabel ><b>Param Value / Salesforce Field Name (API)</b></apex:outputlabel></td>
                                    <td><apex:outputlabel ><b>Value</b></apex:outputlabel></td>
                                </tr>
                                <tr>
                                    <td><apex:outputText >Originating Object <abbr class="slds-required" title="required"> *</abbr></apex:outputText></td>
                                    <td><apex:outputlabel style="{!IF(ISBLANK(originatingObjName),'color:Red;','')}">{!IF(ISBLANK(originatingObjName), 'Not Specified (Required)', originatingObjName)}</apex:outputlabel></td>
                                    <td><apex:outputlabel rendered="{!IF(ISBLANK(originatingObjName),FALSE,TRUE)}">{!sObj['Name']}</apex:outputlabel></td>
                                </tr>
                                <tr>
                                    <td><apex:outputText >Parent Salesforce Acount <abbr class="slds-required" title="required"> *</abbr></apex:outputText></td>
                                    <td><apex:outputlabel style="{!IF(ISBLANK(ParentField),'color:Red;','')}">{!IF(ISBLANK(ParentField), 'Not Specified (Required)', ParentField)}</apex:outputlabel></td>
                                    <td><apex:outputlabel rendered="{!!ISBLANK(ParentField)}" >{!IF(customerMatchType == 'Account', selectedAccount.Name, SelectedContact.Name)}</apex:outputlabel></td>
                                </tr>
                                <tr>
                                    <td><apex:outputText >Payment Amount </apex:outputText></td>
                                    <td><apex:outputlabel>{!IF(ISBLANK(paymentAmountField), 'Not Specified', paymentAmountField)}</apex:outputlabel></td>
                                    <td><apex:outputlabel rendered="{!!ISBLANK(paymentAmountField)}" >{!sObj[paymentAmountField]}</apex:outputlabel></td>
                                </tr>
                                <tr>
                                    <td><apex:outputText >Payment Currency </apex:outputText></td>
                                    <td><apex:outputlabel>{!IF(ISBLANK(paymentCurrencyField), 'Not Specified', paymentCurrencyField)}</apex:outputlabel></td>
                                    <td><apex:outputlabel rendered="{!!ISBLANK(paymentCurrencyField)}" >{!sObj[paymentCurrencyField]}</apex:outputlabel></td>
                                </tr>
                                <tr>
                                    <td><apex:outputText >Payment Description </apex:outputText></td>
                                    <td><apex:outputlabel>{!IF(ISBLANK(paymentDescriptionField), 'Not Specified', paymentDescriptionField)}</apex:outputlabel></td>
                                    <td><apex:outputlabel rendered="{!!ISBLANK(paymentDescriptionField)}" >{!sObj[paymentDescriptionField]}</apex:outputlabel></td>
                                </tr>
                            </table>
                            <div align="center" class="slds-m-vertical_medium">
                                <apex:commandButton styleClass="slds-button slds-button_brand" value="Next" action="{!redirectToNewTransactionPage}" status="action-status" id="goToNewTransactionPanelBtn" disabled="{!!ISBLANK(testingPageException)}" />
                            </div>
                        </apex:outputPanel>
                    </apex:outputPanel>
                    <apex:outputPanel layout="block" rendered="{!IF(testingPage == 'false', true, false)}" id="mainPanel" >
                        <apex:outputPanel rendered="{!If(isPaymentFromStandardNewButton, false, true)}">
                            <!-- ---------------------------- Page Header Start ------------------------------>
                            <div class="slds-page-header slds-m-bottom_medium" role="banner">
                                <div class="slds-media slds-media_center">
                                    <div class="slds-media__figure" id="paymentIcon">
                                        <span class="slds-icon_container slds-icon-standard-user">
                                            <svg class="slds-icon" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/custom-sprite/svg/symbols.svg#custom41')}"></use>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="slds-media__body">
                                        <p class="slds-page-header__title">New Payment</p>
                                        <p class="slds-text-body_small">Breadwinner • Payments</p>
                                    </div>
                                </div>
                            </div>
                            <!----------------------------- Page Header End ------------------------------------>
                            <!----------------------------- Arrow Path Start --------------------------------- -->
                            <apex:outputPanel id="pathPanel" layout="block" styleClass="slds-m-bottom_small" rendered="{!isProcessorConnected}">
                                <article class="slds-card" style="border:0px;box-shadow: 0 0px">
                                    <div class="slds-path slds-path_has-coaching">
                                        <div class="slds-grid slds-path__track">
                                            <div class="slds-grid slds-path__scroller-container">
                                                <div class="slds-path__scroller" role="application">
                                                    <div class="slds-path__scroller_inner">
                                                        <ul class="slds-path__nav" role="listbox" aria-orientation="horizontal">
                                                            <li class="slds-path__item {!if(isCustomerSelected, 'slds-is-complete', 'slds-is-active')}" role="presentation" style="">
                                                                <a aria-selected="true" class="slds-path__link" href="javascript:void(0);" id="path-2" role="option" tabindex="-1">
                                                                    <span class="slds-path__stage">
                                                                        <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                                                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}" />
                                                                        </svg>
                                                                        <apex:outputPanel styleClass="slds-assistive-text">{!if(isCustomerSelected, 'Customer Selected', 'Select Customer')}</apex:outputPanel>
                                                                    </span>
                                                                    <apex:outputPanel styleClass="slds-path__title">{!if(isCustomerSelected, 'Customer Selected', 'Select Customer')}</apex:outputPanel>
                                                                </a>
                                                            </li>
                                                            <li class="slds-path__item {!if(isCustomerCreated, 'slds-is-complete', 'slds-is-incomplete')}" role="presentation" style="display: {!If(selectedBWPCustomer == 'createNewBWPCustomer', '', 'none')}">
                                                                <a aria-selected="true" class="slds-path__link" href="javascript:void(0);" id="path-3" role="option" tabindex="-1">
                                                                    <span class="slds-path__stage">
                                                                        <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                                                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">{!if(isCustomerCreated, 'Customer Created', 'Create Customer')}</span>
                                                                    </span>
                                                                    <span class="slds-path__title">{!if(isCustomerCreated, 'Customer Created', 'Create Customer')}</span>
                                                                </a>
                                                            </li>
                                                            <li class="slds-path__item {!if(isPaymentMethodSelected, 'slds-is-complete', if(PaymentMethodPage, 'slds-is-active', 'slds-is-incomplete'))}" role="presentation"  style="display: {!If(selectedBWPCustomer != 'createNewBWPCustomer', '', 'none')}">
                                                                <a aria-selected="true" class="slds-path__link" href="javascript:void(0);" id="path-2" role="option" tabindex="-1">
                                                                    <span class="slds-path__stage">
                                                                        <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                                                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}" />
                                                                        </svg>
                                                                        <apex:outputPanel styleClass="slds-assistive-text">{!if(isPaymentMethodSelected, 'Payment Method Selected', 'Select Payment Method')}</apex:outputPanel>
                                                                    </span>
                                                                    <apex:outputPanel styleClass="slds-path__title">{!if(isPaymentMethodSelected, 'Payment Method Selected', 'Select Payment Method')}</apex:outputPanel>
                                                                </a>
                                                            </li>
                                                            <li class="slds-path__item {!if(isPaymentMethodCreated, 'slds-is-complete', 'slds-is-incomplete')}" role="presentation" style="display: {!If(OR(selectedBWPCustomer == 'createNewBWPCustomer', selectedPaymentMethod == 'createNewBWPPaymentMethod'), '', 'none')}">
                                                                <a aria-selected="true" class="slds-path__link" href="javascript:void(0);" id="path-3" role="option" tabindex="-1">
                                                                    <span class="slds-path__stage">
                                                                        <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                                                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">{!if(isPaymentMethodCreated, 'Payment Method Added', 'Add Payment Method')}</span>
                                                                    </span>
                                                                    <span class="slds-path__title">{!if(isPaymentMethodCreated, 'Payment Method Added', 'Add Payment Method')}</span>
                                                                </a>
                                                            </li>
                                                            <li class="slds-path__item {!If(TransactionPage, 'slds-is-active', 'slds-is-incomplete')}" role="presentation">
                                                                <a aria-selected="true" class="slds-path__link" href="javascript:void(0);" id="path-4" role="option" tabindex="-1">
                                                                    <span class="slds-path__stage">
                                                                        <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                                                                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#check')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Charge Customer</span>
                                                                    </span>
                                                                    <span class="slds-path__title">Charge Customer</span>
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </apex:outputPanel>
                            <!----------------------------- Arrow Path End -------------------------------------->
                            <!-- -----------------Select BWP Customer Start-------------------------------------->
                            <apex:pageMessages id="pgMsgs"/>
                            
                            <apex:outputPanel id="selectCustomersSection" rendered="{!isProcessorConnected}">
                                <apex:outputPanel rendered="{!CustomerPage}">
                                    <div class="slds-m-top_small slds-col_padded">
                                        <h1 class="slds-section__title">Select the Breadwinner Payments Customer for this Payment</h1>
                                        <fieldset class="slds-form-element slds-m-top_x-small">
                                            <div class="slds-form-element__control">
                                                <label class="slds-radio">
                                                    <input type="radio" name="customeroptions" id="createNewBWPCustomer" onchange="pushselectedBWPCustomer('createNewBWPCustomer');selectCustomer();" value="createNewBWPCustomer" />
                                                    <span class="slds-radio_faux"></span>
                                                    <span class="slds-form-element__label">Create a Breadwinner Payments Customer</span>
                                                    <div class="slds-m-left_x-large slds-text-body_small slds-m-top_x-small">You can have multiple Breadwinner Payments Customers associated with a single Salesforce {!customerMatchType}. This might happen if you have different departments, branches, or offices of the same company. </div>
                                                </label>
                                                <apex:outputPanel rendered="{!customerMatchType == 'Account'}"> 
                                                    <apex:repeat value="{!selectedAccount.BWP_Customers__r}" var="customer">
                                                        <c:CustomerCreationInfo customer="{!customer}" section="customerSection"/>
                                                    </apex:repeat>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!customerMatchType == 'Contact'}"> 
                                                    <apex:repeat value="{!selectedContact.BWP_Customers__r}" var="customer">
                                                        <c:CustomerCreationInfo customer="{!customer}" section="customerSection"/>
                                                    </apex:repeat>
                                                </apex:outputPanel>
                                                
                                            </div>
                                        </fieldset>
                                    </div>
                                    <div class="slds-m-bottom_large slds-m-top_medium" style="text-align:center;">
                                        <apex:commandButton value="Next" id="redirectToPaymentMethodPage" action="{!redirectToPaymentMethodPage}" status="action-status" styleClass="slds-button slds-button_brand slds-m-top_medium" rerender="selectCustomersSection, createPaymentSection, selectPaymentMethodSection, pathPanel" oncomplete="message();reRendercheckmarkSVGIcons();" disabled="{!(selectedObject != customerMatchType)}" />
                                        <apex:commandButton value="Cancel" id="cancel" action="{!cancelProcess}" status="action-status" styleClass="slds-button slds-button_neutral slds-m-top_medium" reRender="selectCustomersSection" oncomplete="message()"/>
                                    </div>
                                    <apex:actionFunction id="selectCustomer" name="selectCustomer" reRender="pathPanel" />
                                </apex:outputPanel>
                                <apex:inputHidden id="selectedBWPCustomer" value="{!selectedBWPCustomer}" />
                                <script>
                                document.getElementById('{!JSENCODE(selectedBWPCustomer)}').checked = true;
                                function pushselectedBWPCustomer(refId) {
                                    document.getElementById('{!JSENCODE($Component.theForm.selectedBWPCustomer)}').value = refId;
                                }
                                </script>
                            </apex:outputPanel>
                            <!-- ----------------- Select BWP Customer End ------------------------------------->
                            <!-- ----------------- Select Payment Method Section Start ----------------------- -->
                            <apex:outputPanel id="selectPaymentMethodSection" rendered="{!isProcessorConnected}">
                                <apex:outputPanel rendered="{!PaymentMethodPage}">
                                    <div class="slds-m-top_small slds-col_padded">
                                        <h1 class="slds-section__title">Select the Payment Method for this Payment</h1>
                                        <fieldset class="slds-form-element slds-m-top_x-small">
                                            <div class="slds-form-element__control">
                                                <label class="slds-radio">
                                                    <input type="radio" name="customeroptions" id="createNewBWPPaymentMethod" onchange="pushselectedBWPPaymentMethod('createNewBWPPaymentMethod');selectPaymentMethod();" value="createNewBWPCustomer" />
                                                    <span class="slds-radio_faux"></span>
                                                    <span class="slds-form-element__label">Add a Payment Method</span>
                                                    <!--div class="slds-m-left_x-large slds-text-body_small slds-m-top_x-small">You can have multiple BWP Customers associated with a single Salesforce Account. This might happen if you have different departments, branches, or offices of the same company. </div-->
                                                </label>
                                                <apex:repeat value="{!customerInfo.Source__r}" var="paymentMethod">
                                                    <apex:outputPanel rendered="{!AND(paymentMethod.Card_Brand__c != NULL, paymentMethod.Last_4_digits__c != NULL)}" layout="block" styleClass="slds-m-top_medium">
                                                        <label class="slds-radio">
                                                            <input type="radio" name="customeroptions" id="{!paymentMethod.Processor_Id__c}" onchange="pushselectedBWPPaymentMethod('{!paymentMethod.Processor_Id__c}');selectPaymentMethod(); " value="{!paymentMethod.Processor_Id__c}" />
                                                            <span class="slds-radio_faux"></span>
                                                            <span class="slds-form-element__label" for="{!paymentMethod.Card_Brand__c}">
                                                                {!paymentMethod.Card_Brand__c}&nbsp;&nbsp; xxxxxxxx{!paymentMethod.Last_4_digits__c} {!if(AND(customerInfo.Default_Source__c != null, paymentMethod.Processor_Id__c != null), (if(customerInfo.Default_Source__c == paymentMethod.Processor_Id__c, '(Default)', '')), '')}
                                                            </span>
                                                        </label>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!AND(paymentMethod.Bank_Name__c != NULL, paymentMethod.Last_4_digits__c != NULL, paymentMethod.Card_Status__c == 'Verified')}" layout="block" styleClass="slds-m-top_medium">
                                                        <label class="slds-radio">
                                                            <input type="radio" name="customeroptions" id="{!paymentMethod.Processor_Id__c}" onchange="pushselectedBWPPaymentMethod('{!paymentMethod.Processor_Id__c}');selectPaymentMethod(); " value="{!paymentMethod.Processor_Id__c}" />
                                                            <span class="slds-radio_faux"></span>
                                                            <span class="slds-form-element__label" for="{!paymentMethod.Last_4_digits__c}">
                                                                {!paymentMethod.Bank_Name__c}&nbsp;&nbsp; xxxxxxxx{!paymentMethod.Last_4_digits__c} {!if(AND(customerInfo.Default_Source__c != null, paymentMethod.Processor_Id__c != null), (if(customerInfo.Default_Source__c == paymentMethod.Processor_Id__c, '(Default)', '')), '')}
                                                            </span>
                                                        </label>
                                                    </apex:outputPanel>
                                                </apex:repeat>
                                            </div>
                                        </fieldset>
                                    </div>
                                    <div class="slds-m-bottom_large" style="text-align:center;">
                                        <apex:commandButton value="Next" id="redirectToTransactionPage" action="{!redirectToTransactionPage}" status="action-status" styleClass="slds-button slds-button_brand slds-m-top_medium" rerender="selectCustomersSection, createPaymentSection, selectPaymentMethodSection, pathPanel" oncomplete="message();reRendercheckmarkSVGIcons();"/>
                                        <apex:commandButton value="Cancel" id="cancelProcess" action="{!showCustomerPanel}" status="action-status" styleClass="slds-button slds-button_neutral slds-m-top_medium" reRender="selectCustomersSection, selectPaymentMethodSection, pathPanel" oncomplete="message();reRendercheckmarkSVGIcons();"/>
                                    </div>
                                    <apex:actionFunction id="selectPaymentMethod" name="selectPaymentMethod" reRender="pathPanel" oncomplete="reRendercheckmarkSVGIcons();"/>
                                </apex:outputPanel>
                                <script>
                                document.getElementById('{!JSENCODE(selectedPaymentMethod)}').checked = true;
                                function pushselectedBWPPaymentMethod(refId) {
                                    console.log('pushing the refid--'+refId);
                                    document.getElementById('{!JSENCODE($Component.theForm.selectedPaymentMethod)}').value = refId;
                                    console.log(document.getElementById('{!JSENCODE($Component.theForm.selectedPaymentMethod)}').value);
                                }
                                </script>
                                <apex:inputHidden id="selectedPaymentMethod" value="{!selectedPaymentMethod}" />
                            </apex:outputPanel>

                            <!-- ----------------- Select Payment Method Section End --------------------------->
                            <!-------------------- Create Payment Method Section Start ------------------------->

                            <!-------------------- Create Payment Method Section End --------------------------->
                            <!-- ----------------- Create Payment Section Start -------------------------------->
                            <apex:outputPanel id="createPaymentSection" rendered="{!isProcessorConnected}">
                                <script>
                                j$("[id$=paymentCurrencies]").select2();
                                </script>
                                <apex:outputPanel rendered="{!TransactionPage}">
                                    <apex:pageMessage id="readOnlyModeInfoMessage" rendered="{!isBreadwinnerReadOnlyMode}" summary="You are using Breadwinner in {!customerInfo.Processor_Type__c} Read Only Mode. While Breadwinner reads data from {!customerInfo.Processor_Type__c}, no changes will be made to {!customerInfo.Processor_Type__c}. {!customerInfo.Processor_Type__c} is in Read-Only mode and will not be altered in any way." severity="INFO" strength="3"/>
                                    <apex:pageMessage id="pagemessage" rendered="{!if(errorMessage != NULL, true, false)}" summary="{!errorMessage}" severity="error" strength="3" />
                                    <apex:pageMessage rendered="{!if(listOfPaymentMethods.size == 0 , true, false)}" summary="No chargeable Payment Methods found for this Customer." severity="warning" strength="3" />
                                    <c:CustomerCreationInfo customer="{!customerInfo}" section="paymentSection"/>
                                    <div class="slds-m-bottom_medium">
                                        <h3 class="slds-section-title_divider slds-m-top_small">Transaction Details</h3>
                                        <div class="slds-grid slds-wrap">
                                            <div class="slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-3 slds-p-left_xx-small">
                                                <apex:outputPanel layout="block" styleClass="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-m-top_small">
                                                    <div class="slds-form-element">
                                                        <span class="slds-form-element__label">{!$ObjectType.BWP_Transaction__c.fields.Currency__c.label}</span>
                                                        <div class="slds-form-element__control">
                                                            <div class="slds-select_container">
                                                                <apex:selectList id="paymentCurrencies" value="{!newTransaction.Currency__c}" size="1" styleClass="slds-select" required="true" onchange="updatePaymentMethodDetails();">
                                                                    <apex:selectOptions value="{!Currencies}"/>
                                                                </apex:selectList>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="block" styleClass="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-m-top_small">
                                                    <div class="slds-form-element">
                                                        <span class="slds-form-element__label">{!$ObjectType.BWP_Transaction__c.fields.Source__c.label}</span>
                                                        <div class="slds-form-element__control">
                                                            <div class="slds-select_container">
                                                                <apex:selectList value="{!selectedPaymentMethod}" rendered="{!listOfPaymentMethods.size > 0}" size="1" styleClass="slds-select" id="PMList" onchange="updatePaymentMethodDetails();">
                                                                    <apex:selectOptions value="{!listOfPaymentMethods}" />
                                                                </apex:selectList>
                                                                <apex:selectList value="{!selectedPaymentMethod}" rendered="{!listOfPaymentMethods.size == 0}" size="1" styleClass="slds-select" id="noPaymentMethods">
                                                                    <apex:selectOption itemLabel="Choose a payment method" itemvalue="Choose a payment method" />
                                                                </apex:selectList>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </apex:outputPanel>
                                                <apex:outputPanel id="cardDetails">
                                                    <apex:inputHidden id="cardType" value="{!paymentMethodInfo.Type__c}" />
                                                    <apex:inputHidden id="cardBrand" value="{!paymentMethodInfo.Card_Brand__c}" />
                                                </apex:outputPanel>
                                                <c:SldsInputText label="{!$ObjectType.BWP_Transaction__c.fields.Amount__c.label}" fieldValue="{!newTransaction.Amount__c}" id="PaymentAmount" styleClass="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-m-top_small" onKeyPressFunction="return validateFloatKeyPress(this,window.event, '{!customerInfo.Processor_Type__c}')" onKeyUpFunction="verifyAmount();"/>
                                                <apex:outputPanel rendered="{!customerInfo.Processor_Type__c == 'Braintree'}" layout="block" id="chargeTaxAmount">
                                                    <c:SldsInputText label="Tax Amount" fieldValue="{!chargeTaxAmount}" id="chargingTaxAmount" onKeyPressFunction="return validateFloatKeyPress(this,window.event, '')" onKeyUpFunction="verifyAmount();" onFocusFunction="clearAmount();"/>
                                                    <div class="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-text-body_small slds-m-top_small">
                                                        Tax Amount is only used for Level 2 processing. The tax amount will not be added to the total transaction amount. If you would like to include tax you should include it in the transaction amount before submitting the transactions.
                                                    </div>
                                                </apex:outputPanel>
                                                <apex:outputPanel styleClass="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-m-top_small slds-m-bottom_xx-small" rendered="{!customerInfo.Processor_Type__c == 'Braintree'}" style="margin-top: 0.50rem;" layout="block" id="taxExempt">
                                                    <div class="slds-form-element__control">
                                                        <span class="slds-checkbox">
                                                            <label class="slds-checkbox__label" >
                                                                <apex:inputCheckbox value="{!chargeIsTaxExempt}" id="chargeIsTaxExempt"/>
                                                                <span class="slds-checkbox_faux"></span>
                                                                <span class="slds-form-element__label slds-m-left_xx-small">Tax Exempt</span>
                                                            </label>
                                                        </span>
                                                    </div>
                                                </apex:outputPanel>
                                                <apex:outputPanel layout="block" styleClass="slds-col_padded slds-m-top_xx-small" id="amountValidationSection"><apex:outputText id="amountValidations" style="color: red;"/></apex:outputPanel>
                                                <apex:actionFunction id="updatePaymentMethodDetails" name="updatePaymentMethodDetails" rerender="cardDetails" action="{!updateSelectedPaymentMethodDetails}" oncomplete="verifyAmount();"/>
                                                <apex:actionFunction id="buttonsSection" name="buttonsSection" rerender="paymentButtonsSection"/>
                                                <apex:outputPanel layout="block" styleClass="slds-col_padded slds-size_1-of-1 slds-medium-size_1-of-1 slds-large-size_1-of-1 slds-m-top_x-small" rendered="{!customerInfo.Processor_Type__c == 'Stripe'}">
                                                    <div class="slds-form-element">
                                                        <span class="slds-form-element__label">{!$ObjectType.BWP_Transaction__c.fields.Description__c.label}</span>
                                                        <div class="slds-form-element__control">
                                                            <apex:inputtext id="PaymentDesc" value="{!newTransaction.Description__c}" styleClass="slds-input" />
                                                        </div>
                                                    </div>
                                                </apex:outputPanel>
                                            </div>
                                        </div>
                                    </div>
                                    <apex:outputPanel styleClass="slds-m-bottom_large" style="text-align:center;" layout="block" id="paymentButtonsSection">
                                        <apex:inputHidden id="idempotencyKey" value="{!idempotencyKey}"/>
                                        <apex:actionFunction id="processKey" name="processKey" reRender="idempotencyKey" />    
                                        <apex:commandButton value="Charge {!If(paymentMethodInfo.Type__c == 'Card', paymentMethodInfo.Card_Brand__c+' Card', 'Bank Account')} {!If(AND(newTransaction.Amount__c != NULL, newTransaction.Amount__c > 0), ('for' + ' '+TEXT(newTransaction.Amount__c)+' '+UPPER(newTransaction.Currency__c)), '')}" id="createPayment" action="{!chargeCustomer}" onclick="setIdempotencyKey();" status="action-status" styleClass="slds-button slds-button_brand slds-m-top_medium" rerender="selectCustomersSection, createPaymentSection, errorMsg" oncomplete="HideStyleSheet();message();" disabled="{!if(OR(listOfPaymentMethods.size == 0, isBreadwinnerReadOnlyMode), true, false)}" />
                                        <apex:commandButton value="Cancel" id="cancelCreatingPayment" action="{!showPaymentMethodPanel}" status="action-status"  styleClass="slds-button slds-button_neutral slds-m-top_medium" rerender="selectCustomersSection, createPaymentSection, selectPaymentMethodSection, pathPanel, pagemessage" oncomplete="HideStyleSheet();message();reRendercheckmarkSVGIcons();"  />
                                    </apex:outputPanel>
                                    <script>
                                    j$('title')[0].innerText = 'New Payment';
                                    function uuidv4() {
                                        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                                            return v.toString(16);
                                        });
                                    }
                                    function setIdempotencyKey(){
                                        const idempotency_key = uuidv4();
                                        j$("[id$=idempotencyKey]").val(idempotency_key);
                                        var idempotencyKey = j$("[id$=idempotencyKey]").val();
                                        if(idempotencyKey!=null) processKey();
                                    }
                                    </script>
                                </apex:outputPanel>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </apex:outputPanel>
                    <!-- ----------------- Create Payment Section End ------------------------------ -->
                </div>
            </apex:form>
        </body>
    </html>
</apex:page>